name: Evolution Cycle with Gemini AI

on:
  workflow_dispatch:
    inputs:
      n_suggestions:
        description: 'Number of refinement suggestions to generate'
        required: false
        default: '5'
        type: string
      max_refinements:
        description: 'Maximum refinements to test per cycle'
        required: false
        default: '3'
        type: string

permissions:
  contents: read

jobs:
  evolution-cycle:
    name: Run Evolution Cycle with Gemini
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Set up Python
        uses: actions/setup-python@65d7f2d534ac1bc67fcd62888c5f4f3d2cb2b236  # v4.7.1
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Pin versions for supply chain security
          pip install mpmath==1.3.0 numpy==2.0.0 scipy==1.13.1
          
          # Install Gemini SDK
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            pip install google-genai==0.3.0
            echo "âœ… Gemini SDK installed"
          else
            echo "âš ï¸  GEMINI_API_KEY not found - will use template-based suggestions"
          fi
      
      - name: Run Evolution Cycle
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "=========================================="
          echo "  IRH EVOLUTION CYCLE - GEMINI POWERED"
          echo "=========================================="
          echo ""
          echo "Configuration:"
          echo "  Max refinements: ${{ inputs.max_refinements }}"
          echo "  Suggestions: ${{ inputs.n_suggestions }}"
          echo ""
          
          # Run main evolution cycle
          python3 demo_evolution_cycle.py
          
          echo ""
          echo "=========================================="
          echo "  TESTING GEMINI ADVISOR DIRECTLY"
          echo "=========================================="
          echo ""
          
          # Test Gemini advisor
          python3 evolution_system/gemini_advisor.py
      
      - name: Upload evolution cycle results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: evolution-cycle-results-${{ github.run_number }}
          path: |
            outputs/evolution_system/*.json
            outputs/evolution_system/*.txt
          retention-days: 30
      
      - name: Display results summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "  RESULTS SUMMARY"
          echo "=========================================="
          
          # Find the most recent result file
          LATEST_RESULT=$(ls -t outputs/evolution_system/evolution_cycle_*.json 2>/dev/null | head -1)
          
          if [ -f "$LATEST_RESULT" ]; then
            echo "âœ… Evolution cycle completed successfully"
            echo ""
            echo "Results file: $LATEST_RESULT"
            echo ""
            
            # Extract key metrics using Python
            python3 << EOF
          import json
          
          with open('$LATEST_RESULT', 'r') as f:
              data = json.load(f)
          
          summary = data.get('summary', {})
          
          print(f"Predictions computed: {summary.get('predictions_count', 'N/A')}")
          
          mean_sigma = summary.get('mean_sigma')
          if isinstance(mean_sigma, (int, float)):
              print(f"Mean Ïƒ-deviation: {mean_sigma:.2f}")
          else:
              print("Mean Ïƒ-deviation: N/A")
          
          pass_rate = summary.get('pass_rate')
          if isinstance(pass_rate, (int, float)):
              print(f"Pass rate: {pass_rate * 100:.1f}%")
          else:
              print("Pass rate: N/A")
          
          print(f"Suggestions generated: {summary.get('suggestions_count', 'N/A')}")
          EOF
          
            echo ""
            echo "ðŸ“Š Full results available in artifacts"
          else
            echo "âš ï¸  No results file found"
          fi
      
      - name: Check Gemini status
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "  GEMINI AI STATUS"
          echo "=========================================="
          
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "âœ… GEMINI_API_KEY is configured"
            echo ""
            echo "Gemini features available:"
            echo "  â€¢ Deep error pattern analysis"
            echo "  â€¢ Novel refinement suggestions"
            echo "  â€¢ Mathematical derivation assistance"
          else
            echo "â„¹ï¸  GEMINI_API_KEY not configured"
            echo ""
            echo "To enable Gemini AI:"
            echo "  1. Go to Repository Settings"
            echo "  2. Navigate to Secrets and variables â†’ Actions"
            echo "  3. Verify GEMINI_API_KEY secret exists"
            echo ""
            echo "Using template-based suggestions as fallback."
          fi
